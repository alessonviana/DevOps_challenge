pipeline { 
  agent any

  triggers {
      pollSCM('H/2 * * * *')
  }

  stages {
    stage('Build Sandbox') {
      when {
          branch 'feature-*'
      }
      environment { 
          IBM_TOKEN = credentials('ibm_registry_token')
          DOCKER_REGISTRY = "us.icr.io/simco" 
          IMAGE_NAME= "cartaosim-b2b-front"
          APP_ENV= "sandbox"
      }
      steps {
          sh 'make image'
      }
    }

    stage('Build Homolog') {
        when {
            branch 'development'
        }
        environment { 
            IBM_TOKEN = credentials('ibm_registry_token')
            DOCKER_REGISTRY = "us.icr.io/simco" 
            IMAGE_NAME= "cartaosim-b2b-front"
            APP_ENV= "homolog"
        }
        steps {
            sh 'make image'
        }
    }

    stage('Build Production') {
      when {
          branch 'master'
      }
      environment { 
          IBM_TOKEN = credentials('ibm_registry_token')
          DOCKER_REGISTRY = "us.icr.io/simco" 
          IMAGE_NAME= "cartaosim-b2b-front"
          APP_ENV= "prod"
      }
      steps {
          sh 'make image'
      }
    }

    stage('Deploy Sanbdox') {
      when {
          branch 'feature-*'
      }
      steps {
        ansibleTower extraVars: '''
        app_base_directory: /home/devops/apps/cartaosim-b2b-front
        app_url: sandbox.empresas.meucartaosim.com.br
        docker_image: us.icr.io/simco/cartaosim-b2b-front
        env: sandbox
        image_port: 4203
        image_tag: sandbox
        stack_name: cartaosim-b2b-front''', jobTemplate: 'Deploy_Docker_Image_Automation', jobType: 'run', throwExceptionWhenFail: true, towerCredentialsId: 'awx', towerLogLevel: 'false', towerServer: 'AWX'
      }
    }

    stage('Deploy Homolog') {
      when {
          branch 'development'
      }
      steps {
        ansibleTower extraVars: '''
        app_base_directory: /home/devops/apps/cartaosim-b2b-front
        app_url: homolog.empresas.meucartaosim.com.br
        docker_image: us.icr.io/simco/cartaosim-b2b-front
        env: homolog
        image_port: 4203
        image_tag: homolog
        stack_name: cartaosim-b2b-front''', jobTemplate: 'Deploy_Docker_Image_Automation', jobType: 'run', throwExceptionWhenFail: true, towerCredentialsId: 'awx', towerLogLevel: 'false', towerServer: 'AWX'
      }
    }

    stage('Deploy Prod') {
      when {
          branch 'master'
      }
      steps {
        ansibleTower extraVars: '''
        app_base_directory: /home/devops/apps/cartaosim-b2b-front
        app_url: empresas.meucartaosim.com.br
        docker_image: us.icr.io/simco/cartaosim-b2b-front
        env: prod
        image_port: 4203
        image_tag: prod
        stack_name: cartaosim-b2b-front''', jobTemplate: 'Deploy_Docker_Image_Workflow', jobType: 'run', templateType: 'workflow', throwExceptionWhenFail: false, towerCredentialsId: 'awx', towerLogLevel: 'false', towerServer: 'AWX'
      }
    }

  }
}